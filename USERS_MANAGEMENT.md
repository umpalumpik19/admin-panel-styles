# Документация: Система управления пользователями (администраторами)

## Обзор

Полнофункциональная система управления администраторами для админ-панели, реализованная на Next.js 16 с использованием Supabase Auth.

## Созданные файлы и их назначение

### 1. TypeScript типы

**`types/users.ts`**
- Определяет все TypeScript типы для работы с пользователями
- Типы:
  - `AdminUser` - основной тип администратора из Supabase Auth
  - `CreateUserFormData` - данные формы создания пользователя
  - `CreateUserPayload` - данные для API создания
  - `CreateUserResponse`, `UsersListResponse`, `DeleteUserResponse` - типы ответов API

### 2. Server Utilities

**`lib/supabase/admin.ts`**
- Создает Supabase клиент с правами администратора (Service Role Key)
- **ВАЖНО**: Использовать ТОЛЬКО на сервере (API routes, Server Components)
- Функция `createAdminClient()` для административных операций с пользователями
- Автоматически проверяет наличие переменных окружения

### 3. API Routes

**`app/api/users/route.ts`**
- **GET** `/api/users` - Получение списка всех администраторов
  - Требует авторизации
  - Возвращает список пользователей с полной информацией
  - Использует Supabase Admin API

- **POST** `/api/users` - Создание нового администратора
  - Требует авторизации
  - Валидация email и пароля (минимум 8 символов)
  - Автоматическое подтверждение email
  - Обработка ошибок (дубликаты, неверные данные)

**`app/api/users/[id]/route.ts`**
- **DELETE** `/api/users/[id]` - Удаление администратора
  - Требует авторизации
  - Защита от удаления самого себя
  - Проверка существования пользователя

### 4. React компоненты

**`components/users/UsersTable.tsx`** (Client Component)
- Таблица со списком всех администраторов
- Функции:
  - Поиск по email
  - Сортировка по дате создания (новые первые)
  - Отображение статуса (активен/не подтверждён)
  - Форматирование дат с помощью date-fns
  - Индикатор текущего пользователя ("Вы")
  - Кнопка удаления (скрыта для текущего пользователя)
  - Интеграция с DeleteUserDialog

**`components/users/CreateUserForm.tsx`** (Client Component)
- Модальная форма создания нового администратора
- Функции:
  - Валидация email (формат)
  - Валидация пароля (минимум 8 символов)
  - Проверка совпадения паролей
  - Отображение ошибок валидации и API
  - Блокировка формы во время отправки
  - Автоматическое закрытие при успехе

**`components/users/DeleteUserDialog.tsx`** (Client Component)
- Модальный диалог подтверждения удаления
- Функции:
  - Предупреждающий UI с иконкой
  - Отображение email удаляемого пользователя
  - Предупреждение о необратимости действия
  - Блокировка кнопок во время удаления
  - Отмена операции

### 5. Главная страница

**`app/(dashboard)/users/page.tsx`** (Client Component)
- Главная страница управления пользователями
- Функции:
  - Загрузка списка пользователей при монтировании
  - Отображение статистики (общее количество админов)
  - Кнопка "Создать администратора"
  - Индикаторы загрузки
  - Обработка ошибок с возможностью повтора
  - Интеграция всех компонентов
  - Автоматическое обновление списка после создания/удаления

## Функциональность

### Реализованные требования

✅ **Таблица всех администраторов**
- Email, дата создания, последний вход
- Статус (активен/не подтверждён)
- Индикатор текущего пользователя

✅ **Создание нового администратора**
- Валидация email (формат)
- Валидация пароля (минимум 8 символов)
- Подтверждение пароля
- Автоматическое подтверждение email

✅ **Удаление администратора**
- С подтверждением через диалог
- Защита от удаления самого себя
- Предупреждение о необратимости

✅ **Безопасность**
- Проверка авторизации на всех API endpoints
- Использование Service Role Key только на сервере
- Валидация всех входных данных
- Защита от самоудаления

✅ **Поиск и фильтрация**
- Поиск по email
- Сортировка по дате создания

✅ **Статистика**
- Отображение общего количества администраторов

## Использование

### Доступ к странице

Перейдите по адресу: `/dashboard/users`

### Создание нового администратора

1. Нажмите кнопку "Создать администратора"
2. Введите email (проверяется формат)
3. Введите пароль (минимум 8 символов)
4. Подтвердите пароль
5. Нажмите "Создать"

### Удаление администратора

1. Найдите пользователя в таблице
2. Нажмите "Удалить" (недоступно для вашей учётной записи)
3. Подтвердите удаление в диалоге

### Поиск пользователя

Введите email или его часть в поле поиска над таблицей.

## Технические детали

### Переменные окружения

Убедитесь, что в `.env.local` присутствуют:
```env
NEXT_PUBLIC_SUPABASE_URL=https://xuatcmcuqhgwmgwifxzd.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
```

### Архитектура

- **Server Components**: Не используются (все компоненты Client для интерактивности)
- **API Routes**: Используют Server-side Supabase клиент с Admin правами
- **State Management**: React useState + useEffect для локального состояния
- **Validation**: Client-side + Server-side для безопасности
- **Error Handling**: Try-catch с user-friendly сообщениями

### Используемые библиотеки

- `@supabase/supabase-js` - Supabase SDK
- `@supabase/ssr` - SSR поддержка
- `date-fns` - Форматирование дат
- `react-hook-form` + `zod` (установлены, но не использованы - можно добавить позже)

## Безопасность

### Защита API

Все API endpoints проверяют авторизацию:
```typescript
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  return NextResponse.json({ success: false, error: 'Необходима авторизация' }, { status: 401 });
}
```

### Service Role Key

Используется ТОЛЬКО на сервере через `lib/supabase/admin.ts`:
- Никогда не передаётся на клиент
- Используется только в API routes
- Позволяет административные операции (создание/удаление пользователей)

### Защита от самоудаления

```typescript
if (id === user.id) {
  return NextResponse.json(
    { success: false, error: 'Нельзя удалить свою собственную учётную запись' },
    { status: 403 }
  );
}
```

## Будущие улучшения

### Возможные расширения

1. **Пагинация** - для больших списков пользователей
2. **Роли и права** - разграничение прав администраторов
3. **История действий** - логирование операций
4. **Массовые операции** - удаление нескольких пользователей
5. **Экспорт данных** - выгрузка списка в CSV/Excel
6. **Фильтры** - по статусу, дате регистрации
7. **Редактирование** - изменение email, сброс пароля
8. **Уведомления** - email при создании учётной записи

### Оптимизация

1. **React Query** - кеширование и синхронизация данных
2. **Optimistic updates** - мгновенный UI feedback
3. **Debounce** для поиска
4. **Virtual scrolling** для больших списков

## Troubleshooting

### Ошибка "Необходима авторизация"
- Проверьте, что вы залогинены в админ-панели
- Проверьте корректность токена в cookies

### Ошибка "Пользователь с таким email уже существует"
- Email должен быть уникальным в системе
- Проверьте существующих пользователей

### Ошибка при создании пользователя
- Проверьте наличие SUPABASE_SERVICE_ROLE_KEY в .env.local
- Проверьте права Service Role Key в Supabase Dashboard

### Не отображается список пользователей
- Откройте DevTools → Network и проверьте запрос к `/api/users`
- Проверьте консоль на наличие ошибок
- Убедитесь, что Supabase доступен

## Контакты и поддержка

При возникновении проблем проверьте:
1. Логи в консоли браузера
2. Логи на сервере (терминал с `npm run dev`)
3. Supabase Dashboard → Auth → Users
4. Переменные окружения в `.env.local`

---

**Статус**: Полностью реализовано и протестировано
**Версия**: 1.0
**Дата**: 2025-03-11
